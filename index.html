<!DOCTYPE html>
<html>
<head>
  <title>Felt Spatial Analyst v2</title>
  <meta charset="UTF-8">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; background: #0f172a; color: #e2e8f0; }
    
    .container { display: flex; height: 100vh; }
    
    .sidebar { width: 380px; background: #1e293b; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }
    .sidebar h1 { font-size: 1.25rem; color: #f8fafc; display: flex; align-items: center; gap: 8px; }
    
    .map-container { flex: 1; position: relative; }
    #map { width: 100%; height: 100%; }
    
    .card { background: #334155; border-radius: 12px; padding: 16px; }
    .card h3 { font-size: 0.875rem; color: #94a3b8; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em; }
    
    input, select { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #475569; background: #1e293b; color: #f8fafc; font-size: 0.875rem; }
    input:focus, select:focus { outline: none; border-color: #6366f1; }
    
    button { padding: 10px 16px; border-radius: 8px; border: none; font-weight: 500; cursor: pointer; transition: all 0.15s; }
    .btn-primary { background: #6366f1; color: white; }
    .btn-primary:hover { background: #4f46e5; }
    .btn-primary:disabled { background: #475569; cursor: not-allowed; }
    .btn-secondary { background: #475569; color: #e2e8f0; }
    .btn-secondary:hover { background: #64748b; }
    
    .tool-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .tool-btn { padding: 12px; text-align: center; border-radius: 8px; background: #475569; border: 2px solid transparent; cursor: pointer; transition: all 0.15s; }
    .tool-btn:hover { background: #64748b; }
    .tool-btn.active { border-color: #6366f1; background: #4338ca; }
    .tool-btn .icon { font-size: 1.5rem; margin-bottom: 4px; }
    .tool-btn .label { font-size: 0.75rem; color: #cbd5e1; }
    
    .param-row { display: flex; gap: 8px; align-items: center; margin-top: 12px; }
    .param-row label { font-size: 0.75rem; color: #94a3b8; min-width: 60px; }
    .param-row input { flex: 1; }
    
    .results { background: #1e293b; border-radius: 12px; padding: 16px; max-height: 300px; overflow-y: auto; }
    .results h4 { color: #6366f1; margin-bottom: 12px; }
    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
    .stat-box { background: #334155; padding: 12px; border-radius: 8px; text-align: center; }
    .stat-value { font-size: 1.5rem; font-weight: 700; color: #f8fafc; }
    .stat-label { font-size: 0.75rem; color: #94a3b8; margin-top: 4px; }
    
    .feature-list { font-size: 0.875rem; }
    .feature-item { padding: 8px 0; border-bottom: 1px solid #475569; }
    .feature-item:last-child { border-bottom: none; }
    
    .crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; z-index: 1000; }
    .crosshair-circle { width: 40px; height: 40px; border: 3px solid #6366f1; border-radius: 50%; position: relative; }
    .crosshair-circle::before, .crosshair-circle::after { content: ''; position: absolute; background: #6366f1; }
    .crosshair-circle::before { width: 2px; height: 12px; left: 50%; top: -8px; transform: translateX(-50%); }
    .crosshair-circle::after { width: 12px; height: 2px; top: 50%; left: -8px; transform: translateY(-50%); }
    .crosshair-label { position: absolute; top: 50px; left: 50%; transform: translateX(-50%); background: #6366f1; color: white; padding: 4px 12px; border-radius: 4px; font-size: 0.75rem; white-space: nowrap; }
    
    .status { padding: 8px 12px; background: #1e293b; border-radius: 8px; font-size: 0.75rem; color: #94a3b8; }
    .status.loading { color: #fbbf24; }
    .status.success { color: #4ade80; }
    .status.error { color: #f87171; }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <h1>ðŸ§ª Felt Spatial Analyst</h1>
      
      <div class="card">
        <h3>Load Map</h3>
        <input type="text" id="map-url" placeholder="Paste Felt map URL...">
        <button class="btn-primary" style="width:100%; margin-top:8px;" onclick="loadMap()">Load Map</button>
      </div>
      
      <div class="card" id="layer-card" class="hidden">
        <h3>Select Layer</h3>
        <select id="layer-select">
          <option value="">Choose a layer...</option>
        </select>
        <div id="layer-info" style="margin-top:8px; font-size:0.75rem; color:#94a3b8;"></div>
      </div>
      
      <div class="card" id="tools-card" class="hidden">
        <h3>Analysis Tools</h3>
        <div class="tool-grid">
          <div class="tool-btn" data-tool="buffer" onclick="selectTool('buffer')">
            <div class="icon">â­•</div>
            <div class="label">Buffer Query</div>
          </div>
          <div class="tool-btn" data-tool="stats" onclick="selectTool('stats')">
            <div class="icon">ðŸ“Š</div>
            <div class="label">Layer Stats</div>
          </div>
          <div class="tool-btn" data-tool="categories" onclick="selectTool('categories')">
            <div class="icon">ðŸ“‹</div>
            <div class="label">Categories</div>
          </div>
          <div class="tool-btn" data-tool="histogram" onclick="selectTool('histogram')">
            <div class="icon">ðŸ“ˆ</div>
            <div class="label">Histogram</div>
          </div>
        </div>
        
        <div id="tool-params" class="hidden" style="margin-top:16px;"></div>
        
        <button class="btn-primary" style="width:100%; margin-top:12px;" id="run-btn" onclick="runAnalysis()">Run Analysis</button>
      </div>
      
      <div id="results" class="results hidden"></div>
      
      <div id="status" class="status">Ready</div>
    </div>
    
    <div class="map-container">
      <div id="map"></div>
      <div class="crosshair hidden" id="crosshair">
        <div class="crosshair-circle"></div>
        <div class="crosshair-label">Analysis Center</div>
      </div>
    </div>
  </div>
  
  <script type="module">
    import { Felt } from "https://esm.run/@feltmaps/js-sdk";
    
    // State
    let felt = null;
    let layers = [];
    let selectedLayer = null;
    let selectedTool = null;
    let viewport = null;
    let layerSchema = null;
    
    // DOM refs
    const mapContainer = document.getElementById('map');
    const layerSelect = document.getElementById('layer-select');
    const resultsDiv = document.getElementById('results');
    const statusDiv = document.getElementById('status');
    const crosshair = document.getElementById('crosshair');
    const toolParams = document.getElementById('tool-params');
    
    function setStatus(msg, type = '') {
      statusDiv.textContent = msg;
      statusDiv.className = 'status ' + type;
    }
    
    function showResults(html) {
      resultsDiv.innerHTML = html;
      resultsDiv.classList.remove('hidden');
    }
    
    // Extract map ID from URL
    function extractMapId(input) {
      const match = input.match(/felt\.com\/map\/[^\/]+-([a-zA-Z0-9]+)/);
      return match ? match[1] : input.trim();
    }
    
    // Load map
    window.loadMap = async function() {
      const url = document.getElementById('map-url').value;
      const mapId = extractMapId(url);
      
      if (!mapId) {
        setStatus('Invalid map URL', 'error');
        return;
      }
      
      setStatus('Loading map...', 'loading');
      mapContainer.innerHTML = '';
      
      try {
        felt = await Felt.embed(mapContainer, mapId);
        setStatus('Map loaded!', 'success');
        
        // Get viewport
        viewport = await felt.getViewport();
        felt.onViewportMoveEnd({ handler: (vp) => { viewport = vp; } });
        
        // Get layers
        layers = await felt.getLayers() || [];
        
        // Populate layer dropdown
        layerSelect.innerHTML = '<option value="">Choose a layer...</option>';
        layers.forEach(layer => {
          const opt = document.createElement('option');
          opt.value = layer.id;
          opt.textContent = layer.name || layer.id;
          layerSelect.appendChild(opt);
        });
        
        document.getElementById('layer-card').classList.remove('hidden');
        
      } catch (e) {
        setStatus('Error: ' + e.message, 'error');
        console.error(e);
      }
    };
    
    // Layer selection
    layerSelect.addEventListener('change', async (e) => {
      selectedLayer = e.target.value;
      if (!selectedLayer) {
        document.getElementById('tools-card').classList.add('hidden');
        return;
      }
      
      setStatus('Loading layer info...', 'loading');
      
      try {
        // Get feature count
        const result = await felt.getFeatures({ layerId: selectedLayer, pageSize: 1 });
        const count = result?.count || 'Unknown';
        
        // Get schema for attribute names
        try {
          const schema = await felt.getLayerSchema({ layerId: selectedLayer });
          layerSchema = schema;
        } catch (e) {
          // Try to infer from first feature
          if (result?.features?.[0]?.properties) {
            layerSchema = { attributes: Object.keys(result.features[0].properties) };
          }
        }
        
        document.getElementById('layer-info').textContent = `${count.toLocaleString()} features`;
        document.getElementById('tools-card').classList.remove('hidden');
        setStatus('Ready', 'success');
        
      } catch (e) {
        setStatus('Error loading layer: ' + e.message, 'error');
      }
    });
    
    // Tool selection
    window.selectTool = function(tool) {
      selectedTool = tool;
      
      // Update UI
      document.querySelectorAll('.tool-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tool === tool);
      });
      
      // Show/hide crosshair for spatial tools
      crosshair.classList.toggle('hidden', tool === 'stats');
      
      // Show tool-specific params
      toolParams.classList.remove('hidden');
      
      if (tool === 'buffer') {
        toolParams.innerHTML = `
          <div class="param-row">
            <label>Radius</label>
            <input type="number" id="buffer-radius" value="100" min="1"> km
          </div>
          <p style="font-size:0.75rem; color:#94a3b8; margin-top:8px;">
            Pan the map to position the crosshair, then click Run.
          </p>
        `;
      } else if (tool === 'categories') {
        const attrs = layerSchema?.attributes || ['(loading...)'];
        toolParams.innerHTML = `
          <div class="param-row">
            <label>Attribute</label>
            <select id="cat-attribute">
              ${attrs.filter(a => !a.startsWith('felt:')).map(a => `<option value="${a}">${a}</option>`).join('')}
            </select>
          </div>
        `;
      } else if (tool === 'histogram') {
        const attrs = layerSchema?.attributes || ['(loading...)'];
        toolParams.innerHTML = `
          <div class="param-row">
            <label>Attribute</label>
            <select id="hist-attribute">
              ${attrs.filter(a => !a.startsWith('felt:')).map(a => `<option value="${a}">${a}</option>`).join('')}
            </select>
          </div>
          <div class="param-row">
            <label>Bins</label>
            <input type="number" id="hist-bins" value="5" min="2" max="20">
          </div>
        `;
      } else {
        toolParams.innerHTML = '<p style="font-size:0.75rem; color:#94a3b8;">Click Run to get layer statistics.</p>';
      }
    };
    
    // Run analysis
    window.runAnalysis = async function() {
      if (!selectedLayer || !selectedTool) {
        setStatus('Select a layer and tool first', 'error');
        return;
      }
      
      setStatus('Running analysis...', 'loading');
      
      try {
        let html = '';
        
        if (selectedTool === 'buffer') {
          // Buffer query using boundary
          const radiusKm = parseFloat(document.getElementById('buffer-radius').value) || 100;
          const center = viewport.center;
          
          // Create bounding box (approximate - 1 degree â‰ˆ 111km at equator)
          const degPerKm = 1 / 111;
          const latDelta = radiusKm * degPerKm;
          const lngDelta = radiusKm * degPerKm / Math.cos(center.latitude * Math.PI / 180);
          
          const boundary = [
            center.longitude - lngDelta,
            center.latitude - latDelta,
            center.longitude + lngDelta,
            center.latitude + latDelta
          ];
          
          // Get count in boundary
          const agg = await felt.getAggregates({ 
            layerId: selectedLayer, 
            boundary 
          });
          
          // Get total count
          const total = await felt.getAggregates({ layerId: selectedLayer });
          
          // Get some features for display
          const features = await felt.getFeatures({ 
            layerId: selectedLayer, 
            boundary,
            pageSize: 10 
          });
          
          const countInBuffer = agg?.count || 0;
          const totalCount = total?.count || 0;
          const pct = totalCount > 0 ? ((countInBuffer / totalCount) * 100).toFixed(1) : 0;
          
          html = `
            <h4>â­• Buffer Query Results</h4>
            <p style="font-size:0.75rem; color:#94a3b8; margin-bottom:12px;">
              ${radiusKm}km radius around ${center.latitude.toFixed(4)}, ${center.longitude.toFixed(4)}
            </p>
            <div class="stat-grid">
              <div class="stat-box">
                <div class="stat-value">${countInBuffer.toLocaleString()}</div>
                <div class="stat-label">In Buffer</div>
              </div>
              <div class="stat-box">
                <div class="stat-value">${pct}%</div>
                <div class="stat-label">of Total (${totalCount.toLocaleString()})</div>
              </div>
            </div>
            ${features?.features?.length > 0 ? `
              <div class="feature-list">
                <strong>Sample features:</strong>
                ${features.features.slice(0, 5).map(f => {
                  const props = f.properties || {};
                  const name = props.place || props.title || props.name || props.acq_date || f.id;
                  return `<div class="feature-item">${name}</div>`;
                }).join('')}
              </div>
            ` : ''}
          `;
          
        } else if (selectedTool === 'stats') {
          // Layer stats
          const agg = await felt.getAggregates({ layerId: selectedLayer });
          
          html = `
            <h4>ðŸ“Š Layer Statistics</h4>
            <div class="stat-grid">
              <div class="stat-box">
                <div class="stat-value">${(agg?.count || 0).toLocaleString()}</div>
                <div class="stat-label">Total Features</div>
              </div>
            </div>
          `;
          
          // Try to get numeric aggregations if we have schema
          if (layerSchema?.attributes) {
            const numericAttrs = layerSchema.attributes.filter(a => 
              !a.startsWith('felt:') && 
              ['brightness', 'mag', 'frp', 'confidence', 'population', 'area', 'value'].some(n => a.toLowerCase().includes(n))
            );
            
            if (numericAttrs.length > 0) {
              html += '<div style="margin-top:12px;">';
              for (const attr of numericAttrs.slice(0, 3)) {
                try {
                  const stats = await felt.getAggregates({
                    layerId: selectedLayer,
                    aggregation: { method: 'avg', attribute: attr }
                  });
                  if (stats?.avg !== undefined) {
                    html += `<div class="feature-item"><strong>${attr}:</strong> avg ${stats.avg.toFixed(2)}</div>`;
                  }
                } catch (e) {}
              }
              html += '</div>';
            }
          }
          
        } else if (selectedTool === 'categories') {
          const attr = document.getElementById('cat-attribute').value;
          
          const cats = await felt.getCategoryData({
            layerId: selectedLayer,
            attribute: attr
          });
          
          html = `
            <h4>ðŸ“‹ Categories: ${attr}</h4>
            <div class="feature-list">
              ${(cats || []).slice(0, 15).map(c => `
                <div class="feature-item">
                  <strong>${c.value || '(empty)'}</strong>: ${c.count.toLocaleString()}
                </div>
              `).join('')}
            </div>
          `;
          
        } else if (selectedTool === 'histogram') {
          const attr = document.getElementById('hist-attribute').value;
          const bins = parseInt(document.getElementById('hist-bins').value) || 5;
          
          const hist = await felt.getHistogramData({
            layerId: selectedLayer,
            attribute: attr,
            steps: { type: 'jenks', count: bins }
          });
          
          const maxCount = Math.max(...(hist || []).map(h => h.count));
          
          html = `
            <h4>ðŸ“ˆ Histogram: ${attr}</h4>
            <div class="feature-list">
              ${(hist || []).map(h => {
                const pct = maxCount > 0 ? (h.count / maxCount * 100) : 0;
                return `
                  <div class="feature-item">
                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                      <span>${h.min?.toFixed(1) || 0} - ${h.max?.toFixed(1) || 0}</span>
                      <span>${h.count.toLocaleString()}</span>
                    </div>
                    <div style="background:#475569; height:8px; border-radius:4px;">
                      <div style="background:#6366f1; height:100%; width:${pct}%; border-radius:4px;"></div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `;
        }
        
        showResults(html);
        setStatus('Analysis complete!', 'success');
        
      } catch (e) {
        setStatus('Error: ' + e.message, 'error');
        console.error(e);
        showResults(`<div style="color:#f87171;">Error: ${e.message}</div>`);
      }
    };
    
    // Pre-fill with test map
    document.getElementById('map-url').value = 'https://felt.com/map/Living-Earth-Animated-Pulse-Map-zH0ZvXraQTep7nfT1L4kSD';
  </script>
</body>
</html>
