<!DOCTYPE html>
<html>
<head>
  <title>Felt Spatial Analyst v2</title>
  <meta charset="UTF-8">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; background: #0f172a; color: #e2e8f0; }
    
    .container { display: flex; height: 100vh; }
    
    .sidebar { width: 380px; background: #1e293b; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 16px; }
    .sidebar h1 { font-size: 1.25rem; color: #f8fafc; display: flex; align-items: center; gap: 8px; }
    
    .map-container { flex: 1; position: relative; }
    #map { width: 100%; height: 100%; }
    
    .card { background: #334155; border-radius: 12px; padding: 16px; }
    .card h3 { font-size: 0.875rem; color: #94a3b8; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em; }
    
    input, select { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #475569; background: #1e293b; color: #f8fafc; font-size: 0.875rem; }
    input:focus, select:focus { outline: none; border-color: #6366f1; }
    
    button { padding: 10px 16px; border-radius: 8px; border: none; font-weight: 500; cursor: pointer; transition: all 0.15s; }
    .btn-primary { background: #6366f1; color: white; width: 100%; margin-top: 8px; }
    .btn-primary:hover { background: #4f46e5; }
    .btn-primary:disabled { background: #475569; cursor: not-allowed; }
    
    .tool-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .tool-btn { padding: 12px; text-align: center; border-radius: 8px; background: #475569; border: 2px solid transparent; cursor: pointer; transition: all 0.15s; }
    .tool-btn:hover { background: #64748b; }
    .tool-btn.active { border-color: #6366f1; background: #4338ca; }
    .tool-btn .icon { font-size: 1.5rem; margin-bottom: 4px; }
    .tool-btn .label { font-size: 0.75rem; color: #cbd5e1; }
    
    .param-row { display: flex; gap: 8px; align-items: center; margin-top: 12px; }
    .param-row label { font-size: 0.75rem; color: #94a3b8; min-width: 70px; }
    .param-row input, .param-row select { flex: 1; }
    
    .results { background: #1e293b; border-radius: 12px; padding: 16px; }
    .results h4 { color: #6366f1; margin-bottom: 12px; font-size: 1rem; }
    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
    .stat-box { background: #334155; padding: 12px; border-radius: 8px; text-align: center; }
    .stat-value { font-size: 1.5rem; font-weight: 700; color: #f8fafc; }
    .stat-label { font-size: 0.75rem; color: #94a3b8; margin-top: 4px; }
    
    .bar-chart { margin-top: 12px; }
    .bar-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.8rem; }
    .bar-label { width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .bar-container { flex: 1; height: 20px; background: #475569; border-radius: 4px; margin: 0 8px; overflow: hidden; }
    .bar-fill { height: 100%; background: linear-gradient(90deg, #6366f1, #8b5cf6); border-radius: 4px; transition: width 0.3s; }
    .bar-value { width: 60px; text-align: right; color: #94a3b8; }
    
    .crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; z-index: 1000; }
    .crosshair-circle { width: 40px; height: 40px; border: 3px solid #6366f1; border-radius: 50%; position: relative; box-shadow: 0 0 20px rgba(99,102,241,0.5); }
    .crosshair-circle::before, .crosshair-circle::after { content: ''; position: absolute; background: #6366f1; }
    .crosshair-circle::before { width: 2px; height: 12px; left: 50%; top: -8px; transform: translateX(-50%); }
    .crosshair-circle::after { width: 12px; height: 2px; top: 50%; left: -8px; transform: translateY(-50%); }
    .crosshair-label { position: absolute; top: 50px; left: 50%; transform: translateX(-50%); background: #6366f1; color: white; padding: 4px 12px; border-radius: 4px; font-size: 0.75rem; white-space: nowrap; }
    
    .status { padding: 8px 12px; background: #1e293b; border-radius: 8px; font-size: 0.75rem; color: #94a3b8; }
    .status.loading { color: #fbbf24; }
    .status.success { color: #4ade80; }
    .status.error { color: #f87171; }
    
    .hidden { display: none !important; }
    .info-text { font-size: 0.75rem; color: #94a3b8; margin-top: 8px; line-height: 1.4; }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <h1>ðŸ§ª Felt Spatial Analyst</h1>
      <p class="info-text">Server-side spatial analysis using Felt SDK</p>
      
      <div class="card">
        <h3>Load Map</h3>
        <input type="text" id="map-url" placeholder="Paste Felt map URL...">
        <button class="btn-primary" onclick="loadMap()">Load Map</button>
      </div>
      
      <div class="card hidden" id="layer-card">
        <h3>Select Layer</h3>
        <select id="layer-select">
          <option value="">Choose a layer...</option>
        </select>
        <div id="layer-info" class="info-text"></div>
      </div>
      
      <div class="card hidden" id="tools-card">
        <h3>Analysis Tools</h3>
        <div class="tool-grid">
          <div class="tool-btn" data-tool="buffer" onclick="selectTool('buffer')">
            <div class="icon">â­•</div>
            <div class="label">Buffer Query</div>
          </div>
          <div class="tool-btn" data-tool="stats" onclick="selectTool('stats')">
            <div class="icon">ðŸ“Š</div>
            <div class="label">Layer Stats</div>
          </div>
          <div class="tool-btn" data-tool="categories" onclick="selectTool('categories')">
            <div class="icon">ðŸ“‹</div>
            <div class="label">Categories</div>
          </div>
          <div class="tool-btn" data-tool="histogram" onclick="selectTool('histogram')">
            <div class="icon">ðŸ“ˆ</div>
            <div class="label">Histogram</div>
          </div>
        </div>
        
        <div id="tool-params" class="hidden"></div>
        
        <button class="btn-primary" id="run-btn" onclick="runAnalysis()">Run Analysis</button>
      </div>
      
      <div id="results" class="results hidden"></div>
      
      <div id="status" class="status">Ready - Using server-side analysis (no feature download needed)</div>
    </div>
    
    <div class="map-container">
      <div id="map"></div>
      <div class="crosshair hidden" id="crosshair">
        <div class="crosshair-circle"></div>
        <div class="crosshair-label">Analysis Center</div>
      </div>
    </div>
  </div>
  
  <script type="module">
    import { Felt } from "https://esm.run/@feltmaps/js-sdk";
    
    // State
    let felt = null;
    let layers = [];
    let selectedLayer = null;
    let selectedTool = null;
    let viewport = null;
    let layerSchema = null;
    let totalFeatureCount = 0;
    
    // DOM refs
    const mapContainer = document.getElementById('map');
    const layerSelect = document.getElementById('layer-select');
    const resultsDiv = document.getElementById('results');
    const statusDiv = document.getElementById('status');
    const crosshair = document.getElementById('crosshair');
    const toolParams = document.getElementById('tool-params');
    
    function setStatus(msg, type = '') {
      statusDiv.textContent = msg;
      statusDiv.className = 'status ' + type;
    }
    
    function showResults(html) {
      resultsDiv.innerHTML = html;
      resultsDiv.classList.remove('hidden');
    }
    
    function extractMapId(input) {
      const match = input.match(/felt\.com\/map\/[^\/]+-([a-zA-Z0-9]+)/);
      return match ? match[1] : input.trim();
    }
    
    // Load map
    window.loadMap = async function() {
      const url = document.getElementById('map-url').value;
      const mapId = extractMapId(url);
      
      if (!mapId) {
        setStatus('Invalid map URL', 'error');
        return;
      }
      
      setStatus('Loading map...', 'loading');
      mapContainer.innerHTML = '';
      
      try {
        felt = await Felt.embed(mapContainer, mapId);
        setStatus('Map loaded!', 'success');
        
        // Get viewport and track changes
        viewport = await felt.getViewport();
        felt.onViewportMoveEnd({ handler: (vp) => { viewport = vp; } });
        
        // Get layers
        layers = await felt.getLayers() || [];
        
        // Populate dropdown
        layerSelect.innerHTML = '<option value="">Choose a layer...</option>';
        layers.forEach(layer => {
          const opt = document.createElement('option');
          opt.value = layer.id;
          opt.textContent = layer.name || layer.id;
          layerSelect.appendChild(opt);
        });
        
        document.getElementById('layer-card').classList.remove('hidden');
        
      } catch (e) {
        setStatus('Error: ' + e.message, 'error');
        console.error(e);
      }
    };
    
    // Layer selection
    layerSelect.addEventListener('change', async (e) => {
      selectedLayer = e.target.value;
      layerSchema = null;
      
      if (!selectedLayer) {
        document.getElementById('tools-card').classList.add('hidden');
        return;
      }
      
      setStatus('Loading layer info...', 'loading');
      
      try {
        // Use getAggregates to get total count (server-side!)
        const countResult = await felt.getAggregates({ layerId: selectedLayer });
        totalFeatureCount = countResult?.count || 0;
        
        // Get schema for attribute names
        try {
          layerSchema = await felt.getLayerSchema({ layerId: selectedLayer });
        } catch (e) {
          // Fallback: get one feature to see properties
          const sample = await felt.getFeatures({ layerId: selectedLayer, pageSize: 1 });
          if (sample?.features?.[0]?.properties) {
            layerSchema = { attributes: Object.keys(sample.features[0].properties) };
          }
        }
        
        document.getElementById('layer-info').innerHTML = `
          <strong>${totalFeatureCount.toLocaleString()}</strong> total features<br>
          <em>Analysis runs on server - no download needed!</em>
        `;
        document.getElementById('tools-card').classList.remove('hidden');
        setStatus('Ready', 'success');
        
      } catch (e) {
        setStatus('Error: ' + e.message, 'error');
        console.error(e);
      }
    });
    
    // Tool selection
    window.selectTool = function(tool) {
      selectedTool = tool;
      
      document.querySelectorAll('.tool-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tool === tool);
      });
      
      // Show crosshair for spatial tools
      crosshair.classList.toggle('hidden', tool === 'stats');
      
      toolParams.classList.remove('hidden');
      
      const attrs = (layerSchema?.attributes || []).filter(a => !a.startsWith('felt:'));
      
      if (tool === 'buffer') {
        toolParams.innerHTML = `
          <div class="param-row">
            <label>Radius (km)</label>
            <input type="number" id="buffer-radius" value="500" min="1" max="5000">
          </div>
          <p class="info-text">Pan map to position crosshair, then click Run. Uses bounding box query on server.</p>
        `;
      } else if (tool === 'categories') {
        toolParams.innerHTML = `
          <div class="param-row">
            <label>Group by</label>
            <select id="cat-attribute">
              ${attrs.map(a => `<option value="${a}">${a}</option>`).join('')}
            </select>
          </div>
          <p class="info-text">Groups all features by attribute value (server-side aggregation).</p>
        `;
      } else if (tool === 'histogram') {
        toolParams.innerHTML = `
          <div class="param-row">
            <label>Attribute</label>
            <select id="hist-attribute">
              ${attrs.map(a => `<option value="${a}">${a}</option>`).join('')}
            </select>
          </div>
          <div class="param-row">
            <label>Bins</label>
            <input type="number" id="hist-bins" value="5" min="2" max="20">
          </div>
          <p class="info-text">Creates histogram bins using Jenks natural breaks.</p>
        `;
      } else {
        toolParams.innerHTML = `<p class="info-text">Gets total count and numeric aggregations for the entire layer.</p>`;
      }
    };
    
    // Run analysis
    window.runAnalysis = async function() {
      if (!selectedLayer || !selectedTool) {
        setStatus('Select a layer and tool first', 'error');
        return;
      }
      
      setStatus('Running server-side analysis...', 'loading');
      
      try {
        let html = '';
        
        if (selectedTool === 'buffer') {
          // Buffer query using boundary parameter
          const radiusKm = parseFloat(document.getElementById('buffer-radius').value) || 500;
          const center = viewport.center;
          
          // Convert km to degrees (approximate)
          const degPerKm = 1 / 111;
          const latDelta = radiusKm * degPerKm;
          const lngDelta = radiusKm * degPerKm / Math.cos(center.latitude * Math.PI / 180);
          
          // Bounding box: [minLng, minLat, maxLng, maxLat]
          const boundary = [
            center.longitude - lngDelta,
            center.latitude - latDelta,
            center.longitude + lngDelta,
            center.latitude + latDelta
          ];
          
          // Server-side count within boundary
          const bufferAgg = await felt.getAggregates({ layerId: selectedLayer, boundary });
          const countInBuffer = bufferAgg?.count || 0;
          const pct = totalFeatureCount > 0 ? ((countInBuffer / totalFeatureCount) * 100).toFixed(1) : 0;
          
          html = `
            <h4>â­• Buffer Query Results</h4>
            <p class="info-text" style="margin-bottom:12px;">
              ~${radiusKm}km around [${center.latitude.toFixed(4)}, ${center.longitude.toFixed(4)}]
            </p>
            <div class="stat-grid">
              <div class="stat-box">
                <div class="stat-value">${countInBuffer.toLocaleString()}</div>
                <div class="stat-label">In Buffer</div>
              </div>
              <div class="stat-box">
                <div class="stat-value">${pct}%</div>
                <div class="stat-label">of ${totalFeatureCount.toLocaleString()}</div>
              </div>
            </div>
          `;
          
          // Try to get category breakdown within buffer
          const attrs = (layerSchema?.attributes || []).filter(a => !a.startsWith('felt:'));
          const catAttr = attrs.find(a => ['satellite', 'confidence', 'type', 'category', 'status'].includes(a.toLowerCase())) || attrs[0];
          
          if (catAttr) {
            try {
              const cats = await felt.getCategoryData({ 
                layerId: selectedLayer, 
                attribute: catAttr,
                boundary 
              });
              
              if (cats && cats.length > 0) {
                const maxCount = Math.max(...cats.map(c => c.count));
                html += `
                  <h4 style="margin-top:16px;">By ${catAttr}</h4>
                  <div class="bar-chart">
                    ${cats.slice(0, 8).map(c => `
                      <div class="bar-row">
                        <div class="bar-label">${c.value || '(empty)'}</div>
                        <div class="bar-container">
                          <div class="bar-fill" style="width: ${(c.count / maxCount * 100)}%"></div>
                        </div>
                        <div class="bar-value">${c.count.toLocaleString()}</div>
                      </div>
                    `).join('')}
                  </div>
                `;
              }
            } catch (e) { console.log('Category breakdown failed:', e); }
          }
          
        } else if (selectedTool === 'stats') {
          // Layer-wide stats
          html = `
            <h4>ðŸ“Š Layer Statistics</h4>
            <div class="stat-grid">
              <div class="stat-box">
                <div class="stat-value">${totalFeatureCount.toLocaleString()}</div>
                <div class="stat-label">Total Features</div>
              </div>
            </div>
          `;
          
          // Try numeric aggregations
          const numericAttrs = (layerSchema?.attributes || []).filter(a => 
            !a.startsWith('felt:') && 
            ['brightness', 'frp', 'confidence', 'mag', 'population', 'area', 'value', 'count', 'scan', 'track'].some(n => a.toLowerCase().includes(n))
          );
          
          if (numericAttrs.length > 0) {
            html += '<div style="margin-top:16px;">';
            for (const attr of numericAttrs.slice(0, 4)) {
              try {
                const [avgResult, sumResult] = await Promise.all([
                  felt.getAggregates({ layerId: selectedLayer, aggregation: { method: 'avg', attribute: attr } }),
                  felt.getAggregates({ layerId: selectedLayer, aggregation: { method: 'sum', attribute: attr } })
                ]);
                
                if (avgResult?.avg !== undefined) {
                  html += `
                    <div class="bar-row">
                      <div class="bar-label"><strong>${attr}</strong></div>
                      <div style="flex:1; font-size:0.8rem;">
                        avg: ${avgResult.avg.toFixed(2)} | sum: ${(sumResult?.sum || 0).toLocaleString()}
                      </div>
                    </div>
                  `;
                }
              } catch (e) { console.log(`Aggregation failed for ${attr}:`, e); }
            }
            html += '</div>';
          }
          
        } else if (selectedTool === 'categories') {
          const attr = document.getElementById('cat-attribute').value;
          
          const cats = await felt.getCategoryData({
            layerId: selectedLayer,
            attribute: attr
          });
          
          const maxCount = Math.max(...(cats || []).map(c => c.count));
          
          html = `
            <h4>ðŸ“‹ Categories: ${attr}</h4>
            <div class="bar-chart">
              ${(cats || []).slice(0, 15).map(c => `
                <div class="bar-row">
                  <div class="bar-label">${c.value || '(empty)'}</div>
                  <div class="bar-container">
                    <div class="bar-fill" style="width: ${(c.count / maxCount * 100)}%"></div>
                  </div>
                  <div class="bar-value">${c.count.toLocaleString()}</div>
                </div>
              `).join('')}
            </div>
          `;
          
        } else if (selectedTool === 'histogram') {
          const attr = document.getElementById('hist-attribute').value;
          const bins = parseInt(document.getElementById('hist-bins').value) || 5;
          
          const hist = await felt.getHistogramData({
            layerId: selectedLayer,
            attribute: attr,
            steps: { type: 'jenks', count: bins }
          });
          
          const maxCount = Math.max(...(hist || []).map(h => h.count));
          
          html = `
            <h4>ðŸ“ˆ Histogram: ${attr}</h4>
            <div class="bar-chart">
              ${(hist || []).map(h => `
                <div class="bar-row">
                  <div class="bar-label">${(h.min ?? 0).toFixed(1)} - ${(h.max ?? 0).toFixed(1)}</div>
                  <div class="bar-container">
                    <div class="bar-fill" style="width: ${(h.count / maxCount * 100)}%"></div>
                  </div>
                  <div class="bar-value">${h.count.toLocaleString()}</div>
                </div>
              `).join('')}
            </div>
          `;
        }
        
        showResults(html);
        setStatus('Analysis complete (server-side)', 'success');
        
      } catch (e) {
        setStatus('Error: ' + e.message, 'error');
        console.error(e);
        showResults(`<div style="color:#f87171;">Error: ${e.message}</div>`);
      }
    };
    
    // Pre-fill with test map
    document.getElementById('map-url').value = 'https://felt.com/map/Living-Earth-Animated-Pulse-Map-zH0ZvXraQTep7nfT1L4kSD';
  </script>
</body>
</html>
